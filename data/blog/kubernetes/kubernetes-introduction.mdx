---
title: 'kubeadm 으로 쿠버네티스 클러스터 버전 업그레이드'
date: '2025-05-08'
tags: ['kubernetes']
draft: true
summary: 'kubeadm 으로 쿠버네티스 클러스터 버전 업그레이드 방법'
images: ['/static/images/kubernetes-intro.jpg']
---

# kubeadm 으로 쿠버네티스 클러스터 버전 업그레이드 방법

> 이 내용은 Kubernetes 공식 문서 [kubeadm 업그레이드 가이드](https://v1-32.docs.kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/)를 기반으로 작성되었습니다.

## 목표

kubeadm을 사용하여 Kubernetes 클러스터를 버전 1.31.0에서 1.32.0으로 업그레이드 합니다.


## 업그레이드 전략

1. 컨트롤 플레인 노드 업그레이드
2. 워커 노드 업그레이드
3. 최소한의 다운타임

## 참고 사항

### 노드 드레이닝

- 모든 노드 업그레이드 시 해당 노드를 먼저 드레이닝해야 합니다.
- 컨트롤 플레인 노드의 경우 CoreDNS Pod 또는 중요 워크로드가 실행 중일 수 있으므로 특히 주의가 필요합니다.
- 드레이닝은 노드의 안전한 업그레이드를 보장하는 중요한 단계입니다.

### kubelet 및 kubeadm 버전 호환성

- Kubernetes 프로젝트는 kubelet과 kubeadm 버전을 일치시키는 것을 권장합니다.
- kubelet 버전은 kubeadm보다 오래된 버전을 사용할 수 있지만, 지원되는 버전 범위 내에 있어야 합니다.

### 업그레이드 후 컨테이너 재시작

- 업그레이드 후 모든 컨테이너가 자동으로 재시작됩니다.
- 이는 컨테이너 사양 해시 값이 변경되기 때문입니다.

### kubelet 서비스 확인
  ```bash
  systemctl status kubelet
  journalctl -xeu kubelet
  ```

### 고급 업그레이드 옵션

- `kubeadm upgrade`는 `UpgradeConfiguration` API 타입을 사용한 고급 구성을 지원합니다.
- 기존 클러스터의 재구성은 지원하지 않으므로, 별도의 재구성 절차를 따라야 합니다.

## 상세 업그레이드 단계

### 1. 사전 준비 및 패키지 확인

#### 1.1 패키지 저장소 업데이트

```bash
sudo apt update
```

#### 1.2 사용 가능한 kubeadm 버전 확인

```bash
apt-cache madison kubeadm
```

출력 예시:
```
  kubeadm | 1.31.8-1.1 | https://pkgs.k8s.io/core:/stable:/v1.31/deb  Packages
  kubeadm | 1.31.7-1.1 | https://pkgs.k8s.io/core:/stable:/v1.31/deb  Packages
  kubeadm | 1.31.6-1.1 | https://pkgs.k8s.io/core:/stable:/v1.31/deb  Packages
  kubeadm | 1.31.5-1.1 | https://pkgs.k8s.io/core:/stable:/v1.31/deb  Packages
  kubeadm | 1.31.4-1.1 | https://pkgs.k8s.io/core:/stable:/v1.31/deb  Packages
  kubeadm | 1.31.3-1.1 | https://pkgs.k8s.io/core:/stable:/v1.31/deb  Packages
  kubeadm | 1.31.2-1.1 | https://pkgs.k8s.io/core:/stable:/v1.31/deb  Packages
  kubeadm | 1.31.1-1.1 | https://pkgs.k8s.io/core:/stable:/v1.31/deb  Packages
  kubeadm | 1.31.0-1.1 | https://pkgs.k8s.io/core:/stable:/v1.31/deb  Packages
```

#### 1.3 원하는 버전이 보이지 않을 경우 패키지 저장소 확인

위의 결과에서 원하는 버전(1.32.x)이 보이지 않기 때문에 패키지 저장소를 확인

1. Kubernetes 패키지 저장소 확인
```bash
sudo cat /etc/apt/sources.list.d/kubernetes.list
```

```bash
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /
```

#### 1.4 Kubernetes 패키지 저장소 URL 업데이트

1. 텍스트 편집기로 Kubernetes apt 저장소 파일 열기
```bash
vi /etc/apt/sources.list.d/kubernetes.list
```

2. URL을 다음 버전으로 변경
```
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /
```

#### 1.5 패키지 저장소 업데이트 및 버전 확인

1. 패키지 저장소 업데이트
```bash
sudo apt update
```

2. 사용 가능한 kubeadm 버전 확인
```bash
sudo apt-cache madison kubeadm
```

예상 출력 예시:
```
  kubeadm | 1.32.4-1.1 | https://pkgs.k8s.io/core:/stable:/v1.32/deb  Packages
  kubeadm | 1.32.3-1.1 | https://pkgs.k8s.io/core:/stable:/v1.32/deb  Packages
  kubeadm | 1.32.2-1.1 | https://pkgs.k8s.io/core:/stable:/v1.32/deb  Packages
  kubeadm | 1.32.1-1.1 | https://pkgs.k8s.io/core:/stable:/v1.32/deb  Packages
  kubeadm | 1.32.0-1.1 | https://pkgs.k8s.io/core:/stable:/v1.32/deb  Packages
```

### 2. 컨트롤 플레인 업그레이드

#### 2.1 컨트롤 플레인 업그레이드 개요

컨트롤 플레인 노드는 한 번에 한 노드씩 업그레이드를 진행해야 합니다. 업그레이드할 컨트롤 플레인 노드를 선택하고, `/etc/kubernetes/admin.conf` 파일이 있는 노드를 사용해야 합니다.

#### 2.2 kubeadm 업그레이드

1. kubeadm 패키지 고정 해제 및 업그레이드
```bash
sudo apt-mark unhold kubeadm && \
sudo apt-get update && \
sudo apt-get install -y kubeadm='1.32.0-*' && \
sudo apt-mark hold kubeadm
```

2. 다운로드 및 버전 확인
```bash
kubeadm version
```

#### 2.3 업그레이드 계획 확인

```bash
sudo kubeadm upgrade plan
```

> - 클러스터 업그레이드 가능 여부를 확인합니다.
> - 업그레이드할 수 있는 쿠버네티스 버전 목록을 가져옵니다.
> - 컴포넌트 구성 버전 상태를 테이블 형식으로 보여줍니다.

#### 2.4 업그레이드 적용

```bash
sudo kubeadm upgrade apply v1.32.0
```

명령어가 완료되면 다음과 같은 메시지가 표시됩니다:

```
[upgrade/successful] SUCCESS! Your cluster was upgraded to "v1.32.0". Enjoy!
[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven't already done so.
```

#### 2.5 kubelet 및 kubectl 업그레이드

1. 컨트롤 플레인 노드 드레인
```bash
# controlplane 은 컨트롤 플레인 노드의 이름입니다.
kubectl drain controlplane --ignore-daemonsets
```

> - 드레인은 노드에서 실행 중인 모든 파드를 안전하게 퇴출시킵니다.
> - `--ignore-daemonsets` 옵션은 데몬셋 파드를 무시하고 드래인을 진행합니다.

2. kubelet 및 kubectl 패키지 고정 해제 및 업그레이드
```bash
# 패키지 고정 해제 및 업그레이드
sudo apt-mark unhold kubelet kubectl && \
sudo apt-get update && \
sudo apt-get install -y kubelet='1.32.0-*' kubectl='1.32.0-*' && \
sudo apt-mark hold kubelet kubectl
```

3. 다운로드 및 버전 확인
```bash
# kubelet 및 kubectl 버전 확인
kubelet --version
kubectl version
```

4. kubelet 서비스 재로드 및 재시작
```bash
# 시스템 데이터 리로드
sudo systemctl daemon-reload

# kubelet 서비스 재시작
sudo systemctl restart kubelet
```

5. 노드 스케줄링 재설정
```bash
# controlplane 은 컨트롤 플레인 노드의 이름입니다.
kubectl uncordon controlplane
```

> - `uncordon` 명령어는 노드를 다시 스케줄링 가능한 상태로 변경합니다.
> - 이전에 드래인한 노드를 다시 활성화합니다.

### 3. 워커 노드 업그레이드

워커 노드는 컨트롤 플레인 노드와 동일한 업그레이드 과정을 따릅니다.

#### 3.1 워커 노드 접속

워커 노드에 접속하여 업그레이드를 진행합니다.

```bash
# worker-node 은 워커 노드의 이름입니다.
ssh worker-node
```

#### 3.2 kubeadm 업그레이드

1. 텍스트 편집기로 Kubernetes apt 저장소 파일 열기
```bash
vi /etc/apt/sources.list.d/kubernetes.list
```

2. URL을 다음 버전으로 변경
```
deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /
```

3. 패키지 저장소 업데이트
```bash
sudo apt update
```

4. 사용 가능한 kubeadm 버전 확인
```bash
sudo apt-cache madison kubeadm
```

5. kubeadm 업그레이드
```bash
sudo apt-mark unhold kubeadm && \
sudo apt-get update && \
sudo apt-get install -y kubeadm='1.32.0-*' && \
sudo apt-mark hold kubeadm
```

6. 다운로드 및 버전 확인
```bash
kubeadm version
```

#### 3.3 kubelet 및 kubectl 업그레이드

1. 워커 노드에서 컨트롤 플레인 노드로 이동
```bash
exit
```

2. 워커 노드 드레인
```bash
# worker-node 은 워커 노드의 이름입니다.
kubectl drain worker-node --ignore-daemonsets
```
pod 가 컨트롤 플레인으로 옮겨갔는지 확인
```bash
kubectl get pods --all-namespaces -o wide
```

3. worker-node 접속
```bash
ssh worker-node
```

4. kubelet 및 kubectl 패키지 고정 해제 및 업그레이드
```bash
sudo apt-mark unhold kubelet kubectl && \
sudo apt-get update && \
sudo apt-get install -y kubelet='1.32.0-*' kubectl='1.32.0-*' && \
sudo apt-mark hold kubelet kubectl
```

5. 다운로드 및 버전 확인
```bash
kubelet --version
kubectl version
```

6. kubelet 서비스 재로드 및 재시작
```bash
# 시스템 데이터 리로드
sudo systemctl daemon-reload

# kubelet 서비스 재시작
sudo systemctl restart kubelet
```

7. 노드 스케줄링 재설정
```bash
kubectl uncordon worker-node
```
